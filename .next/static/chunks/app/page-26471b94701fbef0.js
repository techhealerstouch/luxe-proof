(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{41057:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c});var o=a(95155),r=a(12115),s=a(35695),n=a(94861);function c(){let{user:e}=(0,n.A)(),t=(0,s.useRouter)();return(0,r.useEffect)(()=>{e?t.push("/dashboard"):t.push("/login")},[e,t]),(0,o.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,o.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-gray-900"})})}},90731:(e,t,a)=>{Promise.resolve().then(a.bind(a,41057))},94861:(e,t,a)=>{"use strict";a.d(t,{A:()=>d,AuthProvider:()=>h});var o=a(95155),r=a(12115),s=a(35695),n=a(23464),c=a(56671);let i={ACCESS_TOKEN:"accessToken",REFRESH_TOKEN:"refreshToken",USER:"user",LOGGED_IN:"loggedIn",JUST_LOGGED_IN:"justLoggedIn",AUTH_TOKEN:"auth_token",PKCE_VERIFIER:"pkce_code_verifier"},l={LOGIN:"/login",DASHBOARD:"/dashboard"},u=(0,r.createContext)(null);function h(e){let{children:t}=e,[a,h]=(0,r.useState)(null),[d,p]=(0,r.useState)(!0),g=(0,s.useRouter)(),S="https://stg.luxevipsuite.com",f=(0,r.useCallback)(()=>{Object.values(i).forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)})},[]),E=(0,r.useCallback)(e=>{sessionStorage.setItem(i.USER,JSON.stringify(e)),sessionStorage.setItem(i.LOGGED_IN,"true"),h(e)},[]),m=(0,r.useCallback)(()=>{try{let e=sessionStorage.getItem(i.USER);if(!e)return null;let t=JSON.parse(e);return t.data||t}catch(e){return console.error("Failed to parse stored user:",e),sessionStorage.removeItem(i.USER),null}},[]),w=(0,r.useCallback)(async e=>{let t=localStorage.getItem(i.PKCE_VERIFIER);if(!t)throw Error("PKCE code verifier missing. Please start the login process again.");let a=new URLSearchParams({grant_type:"authorization_code",client_id:"01998003-aa09-70b2-a106-1fd34098f380",redirect_uri:"".concat("https://stgapp.luxeproof.com","/auth/callback"),code:e,code_verifier:t});try{let e=await fetch("".concat(S,"/oauth/token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:a.toString()}),t=await e.json();if(!e.ok)throw console.error("OAuth token error response:",t),Error(t.error_description||"Failed to exchange authorization code");return localStorage.removeItem(i.PKCE_VERIFIER),t}catch(e){throw console.error("Token exchange failed:",e),e}},[S]),C=(0,r.useCallback)(async()=>{try{let e=await fetch("".concat(S,"/api/refresh-token"),{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw Error("Failed to refresh token");return(await e.json()).access_token}catch(e){throw console.error("Token refresh failed:",e),window.location.href=l.LOGIN,e}},[S]),_=(0,r.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=localStorage.getItem(i.ACCESS_TOKEN);if(!t)throw Error("No access token available");try{let a=await fetch("".concat(S,"/api/user"),{method:"GET",headers:{Authorization:"Bearer ".concat(t),Accept:"application/json","Content-Type":"application/json"}});if(!a.ok){if(401===a.status){let t=await C();return localStorage.setItem(i.ACCESS_TOKEN,t),_(e)}throw Error("Failed to fetch user data")}let o=await a.json(),r=o.data||o;return E(r),sessionStorage.getItem(i.JUST_LOGGED_IN)&&(c.o.success("Logged in successfully!"),sessionStorage.removeItem(i.JUST_LOGGED_IN)),e&&g.push(l.DASHBOARD),r}catch(e){throw console.error("Error fetching user data:",e),e}},[S,C,g,E]),I=(0,r.useCallback)(async e=>{let t=localStorage.getItem(i.ACCESS_TOKEN);if(!t)throw Error("No auth token found");console.log(e);let a={name:e.name,email:e.email,phone_number:e.phone_number,timezone:e.timezone,account:{name:e.businessName,slug:e.businessSlug}};try{let e=await n.A.put("".concat(S,"/api/user"),a,{headers:{Authorization:"Bearer ".concat(t),Accept:"application/json","Content-Type":"application/json"}}),o=e.data.data||e.data;return E(o),c.o.success("Watch data submitted successfully"),o}catch(e){throw c.o.error("Profile Update Failed!"),e}},[S,E]),A=(0,r.useCallback)(()=>{let e=localStorage.getItem(i.ACCESS_TOKEN),t=sessionStorage.getItem(i.USER);return!!(e&&t)},[]),y=(0,r.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=localStorage.getItem(i.ACCESS_TOKEN);if(!a)throw Error("No access token available");let o=async a=>fetch(e,{...t,headers:{...t.headers,Authorization:"Bearer ".concat(a),Accept:"application/json","Content-Type":"application/json"}}),r=await o(a);if(401===r.status)try{let e=await C();return localStorage.setItem(i.ACCESS_TOKEN,e),o(e)}catch(e){throw await O(),e}return r},[C]),N=(0,r.useCallback)(async(e,t,a)=>{console.log(e);let o=localStorage.getItem(i.ACCESS_TOKEN);try{let r=await y("".concat(S,"/api/user/change-password"),{headers:{Authorization:"Bearer ".concat(o),Accept:"application/json","Content-Type":"application/json"},method:"PUT",credentials:"include",body:JSON.stringify({currentPassword:e,newPassword:t,newPassword_confirmation:a})});if(!r.ok){let e=await r.json();throw Error(e.message||"Failed to change password")}c.o.success("Password changed successfully!")}catch(e){throw c.o.error(e.message||"Password change failed"),e}},[y,S]),O=(0,r.useCallback)(async()=>{try{let e=localStorage.getItem(i.ACCESS_TOKEN);e&&await fetch("".concat(S,"/api/logout"),{method:"POST",credentials:"include",headers:{Accept:"application/json",Authorization:"Bearer ".concat(e)}})}catch(e){console.error("Logout API call failed:",e)}finally{f(),h(null),window.location.href=l.LOGIN}},[S,f]);return((0,r.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem(i.ACCESS_TOKEN);if(sessionStorage.getItem(i.JUST_LOGGED_IN)&&e){await _(!0);return}let t=m();if(t){h(t),window.location.pathname===l.LOGIN&&g.push(l.DASHBOARD);return}if(e)try{await _(!0)}catch(e){console.error("Failed to restore session:",e),localStorage.removeItem(i.ACCESS_TOKEN)}}catch(e){console.error("Auth initialization error:",e)}finally{p(!1)}})()},[]),d)?(0,o.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:"Loading..."}):(0,o.jsx)(u.Provider,{value:{user:a,isLoading:d,logout:O,updateUser:I,changePassword:N,exchangeAuthorizationCode:w,refreshAccessToken:C,fetchUserData:_,isAuthenticated:A,authenticatedRequest:y},children:t})}let d=()=>{let e=(0,r.useContext)(u);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}}},e=>{var t=t=>e(e.s=t);e.O(0,[374,441,684,358],()=>t(90731)),_N_E=e.O()}]);