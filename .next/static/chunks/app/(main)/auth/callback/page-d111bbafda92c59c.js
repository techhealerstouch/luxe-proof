(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7944],{19946:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var o=r(12115);let a=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),s=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim()};var n={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let c=(0,o.forwardRef)((e,t)=>{let{color:r="currentColor",size:a=24,strokeWidth:c=2,absoluteStrokeWidth:i,className:l="",children:u,iconNode:d,...h}=e;return(0,o.createElement)("svg",{ref:t,...n,width:a,height:a,stroke:r,strokeWidth:i?24*Number(c)/Number(a):c,className:s("lucide",l),...h},[...d.map(e=>{let[t,r]=e;return(0,o.createElement)(t,r)}),...Array.isArray(u)?u:[u]])}),i=(e,t)=>{let r=(0,o.forwardRef)((r,n)=>{let{className:i,...l}=r;return(0,o.createElement)(c,{ref:n,iconNode:t,className:s("lucide-".concat(a(e)),i),...l})});return r.displayName="".concat(e),r}},32021:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});var o=r(95155),a=r(12115),s=r(35695),n=r(51154),c=r(94861);function i(){let{logout:e}=(0,c.A)(),t=(0,s.useSearchParams)(),r=(0,s.useRouter)(),{exchangeAuthorizationCode:i,fetchUserData:l}=(0,c.A)(),[u,d]=(0,a.useState)("processing"),[h,g]=(0,a.useState)(""),m="https://stg.luxevipsuite.com",f=(0,a.useRef)(!1),p=(0,a.useRef)(!1);return((0,a.useEffect)(()=>{if(f.current)return;f.current=!0;let o=t.get("code"),a=t.get("error");if(t.get("state"),a){console.error("OAuth error:",a),d("error"),g("Authentication was cancelled or failed"),setTimeout(()=>{r.push("/login?error=oauth_failed")},2e3);return}if(!o){console.error("No authorization code received"),d("error"),g("No authorization code received"),setTimeout(()=>{r.push("/login?error=no_code")},2e3);return}(async()=>{var t,a,s;if(p.current){console.log("Already processing authentication");return}p.current=!0;try{let a=localStorage.getItem("accessToken"),s=sessionStorage.getItem("oauth_processed");if(a&&s===o){console.log("Code already processed, redirecting to dashboard"),r.push("/dashboard");return}sessionStorage.setItem("oauth_processed",o),sessionStorage.setItem("justLoggedIn","true"),console.log("Exchanging authorization code...");let n=await i(o);if(!n||!n.access_token)throw Error("No access token received from server");if(console.log("Token exchange successful"),localStorage.setItem("accessToken",n.access_token),n.refresh_token)try{await fetch("".concat(m,"/api/store-refresh-token"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n.access_token)},body:JSON.stringify({refresh_token:n.refresh_token})})}catch(e){console.warn("Failed to store refresh token in cookie:",e)}let c=n.access_token,l=await fetch("".concat(m,"/api/user"),{method:"GET",headers:{Authorization:"Bearer ".concat(c),"Content-Type":"application/json"}});if(!l.ok)throw Error("Failed to fetch user data");let u=await l.json(),h=null==u?void 0:u.data;if(!h)throw Error("User data missing in response");if(!(null===(t=h.roles)||void 0===t?void 0:t.some(e=>"authenticator"===e.name))){d("error"),g("You do not have the required authenticator role to access Luxe Proof."),setTimeout(()=>e(),2e3);return}window.location.href="/dashboard"}catch(e){console.error("OAuth callback error:",e),sessionStorage.removeItem("oauth_processed"),sessionStorage.removeItem("justLoggedIn"),localStorage.removeItem("accessToken"),d("error"),(null===(a=e.message)||void 0===a?void 0:a.includes("invalid_grant"))?g("Authorization code has expired or was already used. Please try logging in again."):(null===(s=e.message)||void 0===s?void 0:s.includes("redirect_uri"))?g("Configuration error. Please contact support."):g(e.message||"Authentication failed. Please try again."),setTimeout(()=>{r.push("/login?error=auth_failed")},3e3)}finally{p.current=!1}})()},[]),"error"===u)?(0,o.jsxs)("div",{className:"flex h-screen items-center justify-center flex-col gap-4 bg-gray-50",children:[(0,o.jsx)("div",{className:"text-red-500",children:(0,o.jsx)("svg",{className:"h-12 w-12",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),(0,o.jsx)("p",{className:"text-gray-800 font-medium text-center max-w-md",children:h}),(0,o.jsx)("p",{className:"text-sm text-gray-500",children:"Redirecting to login..."})]}):(0,o.jsxs)("div",{className:"flex h-screen items-center justify-center flex-col gap-4 bg-gray-50",children:[(0,o.jsx)(n.A,{className:"h-10 w-10 animate-spin text-gray-700"}),(0,o.jsx)("p",{className:"text-gray-800 font-medium text-lg",children:"Completing authentication..."}),(0,o.jsx)("p",{className:"text-sm text-gray-500",children:"Please wait while we set up your account"})]})}},44700:(e,t,r)=>{Promise.resolve().then(r.bind(r,32021))},51154:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});let o=(0,r(19946).A)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},94861:(e,t,r)=>{"use strict";r.d(t,{A:()=>h,AuthProvider:()=>d});var o=r(95155),a=r(12115),s=r(35695),n=r(23464),c=r(56671);let i={ACCESS_TOKEN:"accessToken",REFRESH_TOKEN:"refreshToken",USER:"user",LOGGED_IN:"loggedIn",JUST_LOGGED_IN:"justLoggedIn",AUTH_TOKEN:"auth_token",PKCE_VERIFIER:"pkce_code_verifier"},l={LOGIN:"/login",DASHBOARD:"/dashboard"},u=(0,a.createContext)(null);function d(e){let{children:t}=e,[r,d]=(0,a.useState)(null),[h,g]=(0,a.useState)(!0),m=(0,s.useRouter)(),f="https://stg.luxevipsuite.com",p=(0,a.useCallback)(()=>{Object.values(i).forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)})},[]),S=(0,a.useCallback)(e=>{sessionStorage.setItem(i.USER,JSON.stringify(e)),sessionStorage.setItem(i.LOGGED_IN,"true"),d(e)},[]),w=(0,a.useCallback)(()=>{try{let e=sessionStorage.getItem(i.USER);if(!e)return null;let t=JSON.parse(e);return t.data||t}catch(e){return console.error("Failed to parse stored user:",e),sessionStorage.removeItem(i.USER),null}},[]),E=(0,a.useCallback)(async e=>{let t=localStorage.getItem(i.PKCE_VERIFIER);if(!t)throw Error("PKCE code verifier missing. Please start the login process again.");let r=new URLSearchParams({grant_type:"authorization_code",client_id:"01998003-aa09-70b2-a106-1fd34098f380",redirect_uri:"".concat("https://stgapp.luxeproof.com","/auth/callback"),code:e,code_verifier:t});try{let e=await fetch("".concat(f,"/oauth/token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:r.toString()}),t=await e.json();if(!e.ok)throw console.error("OAuth token error response:",t),Error(t.error_description||"Failed to exchange authorization code");return localStorage.removeItem(i.PKCE_VERIFIER),t}catch(e){throw console.error("Token exchange failed:",e),e}},[f]),y=(0,a.useCallback)(async()=>{try{let e=await fetch("".concat(f,"/api/refresh-token"),{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw Error("Failed to refresh token");return(await e.json()).access_token}catch(e){throw console.error("Token refresh failed:",e),window.location.href=l.LOGIN,e}},[f]),k=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=localStorage.getItem(i.ACCESS_TOKEN);if(!t)throw Error("No access token available");try{let r=await fetch("".concat(f,"/api/user"),{method:"GET",headers:{Authorization:"Bearer ".concat(t),Accept:"application/json","Content-Type":"application/json"}});if(!r.ok){if(401===r.status){let t=await y();return localStorage.setItem(i.ACCESS_TOKEN,t),k(e)}throw Error("Failed to fetch user data")}let o=await r.json(),a=o.data||o;return S(a),sessionStorage.getItem(i.JUST_LOGGED_IN)&&(c.o.success("Logged in successfully!"),sessionStorage.removeItem(i.JUST_LOGGED_IN)),e&&m.push(l.DASHBOARD),a}catch(e){throw console.error("Error fetching user data:",e),e}},[f,y,m,S]),_=(0,a.useCallback)(async e=>{let t=localStorage.getItem(i.ACCESS_TOKEN);if(!t)throw Error("No auth token found");console.log(e);let r={name:e.name,email:e.email,phone_number:e.phone_number,timezone:e.timezone,account:{name:e.businessName,slug:e.businessSlug}};try{let e=await n.A.put("".concat(f,"/api/user"),r,{headers:{Authorization:"Bearer ".concat(t),Accept:"application/json","Content-Type":"application/json"}}),o=e.data.data||e.data;return S(o),c.o.success("Watch data submitted successfully"),o}catch(e){throw c.o.error("Profile Update Failed!"),e}},[f,S]),C=(0,a.useCallback)(()=>{let e=localStorage.getItem(i.ACCESS_TOKEN),t=sessionStorage.getItem(i.USER);return!!(e&&t)},[]),A=(0,a.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=localStorage.getItem(i.ACCESS_TOKEN);if(!r)throw Error("No access token available");let o=async r=>fetch(e,{...t,headers:{...t.headers,Authorization:"Bearer ".concat(r),Accept:"application/json","Content-Type":"application/json"}}),a=await o(r);if(401===a.status)try{let e=await y();return localStorage.setItem(i.ACCESS_TOKEN,e),o(e)}catch(e){throw await N(),e}return a},[y]),v=(0,a.useCallback)(async(e,t,r)=>{console.log(e);let o=localStorage.getItem(i.ACCESS_TOKEN);try{let a=await A("".concat(f,"/api/user/change-password"),{headers:{Authorization:"Bearer ".concat(o),Accept:"application/json","Content-Type":"application/json"},method:"PUT",credentials:"include",body:JSON.stringify({currentPassword:e,newPassword:t,newPassword_confirmation:r})});if(!a.ok){let e=await a.json();throw Error(e.message||"Failed to change password")}c.o.success("Password changed successfully!")}catch(e){throw c.o.error(e.message||"Password change failed"),e}},[A,f]),N=(0,a.useCallback)(async()=>{try{let e=localStorage.getItem(i.ACCESS_TOKEN);e&&await fetch("".concat(f,"/api/logout"),{method:"POST",credentials:"include",headers:{Accept:"application/json",Authorization:"Bearer ".concat(e)}})}catch(e){console.error("Logout API call failed:",e)}finally{p(),d(null),window.location.href=l.LOGIN}},[f,p]);return((0,a.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem(i.ACCESS_TOKEN);if(sessionStorage.getItem(i.JUST_LOGGED_IN)&&e){await k(!0);return}let t=w();if(t){d(t),window.location.pathname===l.LOGIN&&m.push(l.DASHBOARD);return}if(e)try{await k(!0)}catch(e){console.error("Failed to restore session:",e),localStorage.removeItem(i.ACCESS_TOKEN)}}catch(e){console.error("Auth initialization error:",e)}finally{g(!1)}})()},[]),h)?(0,o.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:"Loading..."}):(0,o.jsx)(u.Provider,{value:{user:r,isLoading:h,logout:N,updateUser:_,changePassword:v,exchangeAuthorizationCode:E,refreshAccessToken:y,fetchUserData:k,isAuthenticated:C,authenticatedRequest:A},children:t})}let h=()=>{let e=(0,a.useContext)(u);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}}},e=>{var t=t=>e(e.s=t);e.O(0,[794,6671,8441,1684,7358],()=>t(44700)),_N_E=e.O()}]);